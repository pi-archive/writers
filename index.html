<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STATION.CORE vFinal - Firebase Blue Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;800&display=swap');
        
        /* [스타일 유지] */
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #ffffff; font-family: 'Pretendard', sans-serif; color: #0000FF; }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; }
        
        header { 
            position: fixed; top: 15px; width: 97%; left: 1.5%; display: flex; justify-content: space-between; align-items: center; 
            padding: 12px 30px; z-index: 1000; background: #0000FF; border-radius: 15px; box-sizing: border-box; 
            box-shadow: 0 10px 40px rgba(0, 0, 255, 0.3);
        }
        .logo { font-weight: 900; color: #fff; cursor: pointer; text-decoration: none; font-size: 1.1rem; letter-spacing: 2px; }
        nav { display: flex; gap: 6px; align-items: center; }
        .nav-link { font-size: 0.7rem; font-weight: 800; color: #fff; cursor: pointer; text-transform: uppercase; padding: 6px 10px; border-radius: 8px; transition: 0.3s; opacity: 0.8; }
        .nav-link:hover { opacity: 1; background: rgba(255,255,255,0.2); }
        .search-area { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 10px; display: flex; align-items: center; margin-left: 10px; }
        .search-area input { background: transparent; border: none; color: #fff; outline: none; font-size: 0.75rem; width: 110px; }
        .search-area input::placeholder { color: rgba(255,255,255,0.6); }

        .app-layer {
            position: absolute; top: 52%; left: 50%; transform: translate(-50%, -50%);
            width: 96%; height: 80vh; z-index: 500;
            background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(50px);
            border-radius: 35px; padding: 45px; display: none; overflow-y: auto; 
            border: 2px solid #0000FF; box-sizing: border-box;
            box-shadow: 0 40px 100px rgba(0, 0, 255, 0.1);
        }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 30px; }
        .card { padding: 30px; border-radius: 20px; position: relative; transition: 0.3s; box-shadow: 0 10px 20px rgba(0,0,255,0.05); background: #fff; border: 1px solid rgba(0,0,255,0.1); }

        /* [테마 스타일] */
        .archive-paper { background: #fff; border: 1px solid #eee; padding: 70px; border-radius: 25px; width: 100%; box-sizing: border-box; box-shadow: 0 20px 40px rgba(0,0,0,0.05); }
        .theme-characters { border-top: 8px solid #0000FF; }
        .char-avatar { width: 55px; height: 55px; border-radius: 50%; background: #0000FF11; border: 2px dashed #0000FF33; margin-bottom: 15px; }
        .theme-mystery { background: #000 !important; color: #00ff41 !important; border: 1px solid #00ff41 !important; font-family: 'JetBrains Mono', monospace !important; }
        .theme-mystery label { color: #00ff41 !important; opacity: 0.6; }
        .theme-fantasy { background: #fdf5e6; color: #432818; border: 2px solid #d2b48c; }
        .theme-inventory { border-left: 10px solid #0000FF; background: #f8fafc; }
        .type-badge { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 0.65rem; font-weight: 900; color: #fff; margin-bottom: 10px; }
        .badge-book { background: #0000FF; } .badge-movie { background: #00d1ff; }
        .theme-ideas { background: #ffffd5; color: #333; transform: rotate(-0.5deg); }

        .view-mode { margin-bottom: 15px; white-space: pre-wrap; line-height: 1.8; color: #333; }
        .edit-mode { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #0000FF33; display: none; font-family: inherit; margin-bottom: 10px; box-sizing: border-box; outline: none; }
        .btn-group { display: flex; gap: 8px; margin-top: 20px; border-top: 1px solid #eee; padding-top: 15px; }
        .btn { cursor: pointer; border: none; padding: 7px 15px; border-radius: 8px; font-weight: 800; font-size: 0.65rem; text-transform: uppercase; transition: 0.2s; }
        .btn-edit { background: #0000FF; color: #fff; }
        .btn-save { background: #28a745; color: #fff; display: none; }
        .btn-del { background: #ff4d4d11; color: #ff4d4d; margin-left: auto; }
        label { font-size: 0.6rem; font-weight: 900; color: #0000FF; text-transform: uppercase; display: block; margin-bottom: 8px; letter-spacing: 1.5px; opacity: 0.6; }

        .main-widgets { position: fixed; bottom: 30px; right: 30px; width: 280px; z-index: 1000; display: flex; flex-direction: column; gap: 12px; }
        .widget { background: #0000FF; color: #fff; padding: 22px; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,255,0.3); }
        .todo-widget { background: #fff; color: #0000FF; border: 2px solid #0000FF; }
    </style>
</head>
<body>

    <header>
        <a class="logo" onclick="location.reload()">STATION.CORE vFire</a>
        <nav>
            <div class="nav-link" onclick="openApp('archive')">Archive</div>
            <div class="nav-link" onclick="openApp('characters')">Chars</div>
            <div class="nav-link" onclick="openApp('mystery')">Mystery</div>
            <div class="nav-link" onclick="openApp('fantasy')">Fantasy</div>
            <div class="nav-link" onclick="openApp('inventory')">Inven</div>
            <div class="nav-link" onclick="openApp('scraps')">Scraps</div>
            <div class="nav-link" onclick="openApp('ideas')" style="color:#FFD700;">Ideas</div>
            <div class="search-area"><input type="text" id="globalSearch" placeholder="SEARCH ALL..." oninput="searchContent()"></div>
        </nav>
    </header>

    <div class="main-widgets">
        <div class="widget">
            <div style="display:flex; justify-content:space-between; font-size:0.7rem; font-weight:900;"><span>PROGRESS</span><span id="perc">0%</span></div>
            <div style="height:6px; background:rgba(255,255,255,0.3); border-radius:3px; margin:12px 0;"><div id="fill" style="height:100%; background:#fff; width:0%;"></div></div>
            <div style="display:flex; gap:6px;">
                <input type="number" id="cur" onchange="updateGoal()" placeholder="NOW" style="width:50%; background:transparent; border:1px solid rgba(255,255,255,0.5); color:#fff; text-align:center; padding:5px; border-radius:5px;"> 
                <input type="number" id="tar" onchange="updateGoal()" placeholder="GOAL" style="width:50%; background:transparent; border:1px solid rgba(255,255,255,0.5); color:#fff; text-align:center; padding:5px; border-radius:5px;">
            </div>
        </div>
        <div class="widget todo-widget">
            <div id="todo-list" style="font-size:0.8rem; max-height:100px; overflow-y:auto; margin-bottom:10px;"></div>
            <input type="text" id="todo-in" placeholder="+ Checklist" onkeypress="addTodo(event)" style="width:100%; border:none; border-bottom:1px solid #0000FF44; color:#0000FF; outline:none; font-size:0.8rem; background:transparent;">
        </div>
    </div>

    <div id="app" class="app-layer"></div>

    <script type="importmap"> { "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } } </script>
    <script type="module">
        import * as THREE from 'three';
        const scene = new THREE.Scene(); 
        const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000); camera.position.z = 22;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight); document.body.appendChild(renderer.domElement);
        
        function createMatrixTexture(text) {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            canvas.width = 1024; canvas.height = 128; ctx.fillStyle = '#0000FF'; ctx.fillRect(0,0,1024,128);
            ctx.font = 'bold 44px monospace'; ctx.fillStyle = '#ffffff'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(text, 512, 64); return new THREE.CanvasTexture(canvas);
        }

        const ribbons = [];
        const texts = ["STATION_FIREBASE", "CLOUD_SYNC_ON", "DATA_STREAMING", "INSPIRATION_LOCKED"];
        texts.forEach((t, i) => {
            const mesh = new THREE.Mesh(new THREE.TorusGeometry(12 + i * 5, 0.3, 16, 100), new THREE.MeshBasicMaterial({ map: createMatrixTexture(t), transparent: true, opacity: 0.6 }));
            mesh.rotation.x = Math.random() * Math.PI; mesh.rotation.y = Math.random() * Math.PI;
            scene.add(mesh); ribbons.push(mesh);
        });

        function animate() {
            requestAnimationFrame(animate);
            ribbons.forEach((r, i) => { r.rotation.x += 0.0008 * (i + 1); r.rotation.y += 0.0012; r.material.map.offset.x -= 0.003; });
            renderer.render(scene, camera);
        }
        animate();
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAU-v2C1UOMnsEVxbuIU3GzwsFHxAA1gBI",
            authDomain: "writersstation-c851b.firebaseapp.com",
            projectId: "writersstation-c851b",
            storageBucket: "writersstation-c851b.firebasestorage.app",
            messagingSenderId: "424303205898",
            appId: "1:424303205898:web:f8a34bf0d96d7487c209f3",
            measurementId: "G-759ZQ9H03E"
        };

        const firebaseApp = initializeApp(firebaseConfig);
        const db = getFirestore(firebaseApp);
        const docRef = doc(db, "station", "main_db");

        let localDB = { archive: [], characters: [], mystery: [], fantasy: [], inventory: [], scraps: [], ideas: [], todos: [], goal: {cur:0, tar:10000} };
        let currentView = 'archive';

        // 실시간 리스너
        onSnapshot(docRef, (snapshot) => {
            if (snapshot.exists()) {
                localDB = snapshot.data();
                updateUI();
                if(document.getElementById('app').style.display === 'block') renderContent(currentView);
            }
        });

        async function save() {
            await setDoc(docRef, localDB);
        }

        window.openApp = (type) => {
            currentView = type;
            document.getElementById('app').style.display = 'block';
            renderContent(type);
        };

        window.renderContent = (type, filter = '') => {
            const app = document.getElementById('app');
            app.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                <h2 style="margin:0; font-weight:900; font-size:2rem; color:#0000FF;">${type.toUpperCase()}</h2>
                <button onclick="addNew('${type}')" style="background:#0000FF; color:#fff; border:none; padding:12px 30px; border-radius:15px; cursor:pointer; font-weight:900;">+ CREATE NEW</button>
            </div><div class="${type==='archive'?'':'grid'}" id="list"></div>`;
            
            const list = document.getElementById('list');
            localDB[type].forEach((item, idx) => {
                if (filter && !Object.values(item).some(v => String(v).toLowerCase().includes(filter.toLowerCase()))) return;
                const div = document.createElement('div');
                div.className = type === 'archive' ? 'archive-paper' : `card theme-${type}`;
                div.id = `card-${type}-${idx}`;
                
                let inner = "";
                if(type === 'archive') {
                    inner = `<label>CHAPTER TITLE</label><div class="view-mode" style="font-weight:900; font-size:1.8rem; margin-bottom:25px; color:#0000FF;">${item.v1 || '제목 없음'}</div><textarea class="edit-mode" id="in-archive-${idx}-v1">${item.v1 || ''}</textarea><label>MANUSCRIPT</label><div class="view-mode">${item.v2 || '...'}</div><textarea class="edit-mode" id="in-archive-${idx}-v2" style="height:600px; line-height:2;">${item.v2 || ''}</textarea>`;
                } else if(type === 'characters') {
                    inner = `<div class="char-avatar"></div><label>NAME</label><div class="view-mode" style="font-weight:900; font-size:1.3rem;">${item.v1 || '인물명'}</div><input class="edit-mode" id="in-characters-${idx}-v1" value="${item.v1 || ''}"><label>BIO</label><div class="view-mode">${item.v2 || '인물 설정...'}</div><textarea class="edit-mode" id="in-characters-${idx}-v2">${item.v2 || ''}</textarea>`;
                } else if(type === 'inventory') {
                    inner = `<div class="type-badge ${item.v1==='MOVIE'?'badge-movie':'badge-book'}">${item.v1 || 'BOOK'}</div><label>SOURCE</label><div class="view-mode" style="font-weight:bold;">${item.v2 || '출처 입력'}</div><div class="edit-mode"><select id="in-inventory-${idx}-v1" style="width:100%; margin-bottom:10px;"><option value="BOOK" ${item.v1==='BOOK'?'selected':''}>BOOK</option><option value="MOVIE" ${item.v1==='MOVIE'?'selected':''}>MOVIE</option></select><input id="in-inventory-${idx}-v2" value="${item.v2 || ''}" style="width:100%;"></div><label>DECODED SENTENCE</label><div class="view-mode" style="font-style:italic;">"${item.v3 || '...'}"</div><textarea class="edit-mode" id="in-inventory-${idx}-v3">${item.v3 || ''}</textarea>`;
                } else if(type === 'mystery') {
                    inner = `<label>CASE_ID</label><div class="view-mode" style="font-weight:900;">${item.v1 || '미결 사건'}</div><input class="edit-mode" id="in-mystery-${idx}-v1" value="${item.v1 || ''}"><label>EVIDENCE</label><div class="view-mode">${item.v2 || '사건 내용...'}</div><textarea class="edit-mode" id="in-mystery-${idx}-v2">${item.v2 || ''}</textarea>`;
                } else if(type === 'fantasy') {
                    inner = `<label>LOCATION</label><div class="view-mode" style="font-weight:900;">${item.v1 || '장소'}</div><input class="edit-mode" id="in-fantasy-${idx}-v1" value="${item.v1 || ''}"><label>LORE</label><div class="view-mode">${item.v2 || '세계관 설정...'}</div><textarea class="edit-mode" id="in-fantasy-${idx}-v2">${item.v2 || ''}</textarea>`;
                } else {
                    inner = `<label>FRAGMENT / IDEA</label><div class="view-mode">${item.v1 || '생각 기록'}</div><textarea class="edit-mode" id="in-${type}-${idx}-v1">${item.v1 || ''}</textarea>`;
                }

                div.innerHTML = inner + `<div class="btn-group">
                    <button class="btn btn-edit" onclick="toggleEdit('${type}',${idx},true)">EDIT</button>
                    <button class="btn btn-save" onclick="saveEntry('${type}',${idx})">SAVE</button>
                    <button class="btn btn-del" onclick="delEntry('${type}',${idx})">✕</button>
                </div>`;
                list.appendChild(div);
            });
        };

        window.toggleEdit = (t, i, e) => {
            const c = document.getElementById(`card-${t}-${i}`);
            c.querySelectorAll('.view-mode').forEach(v => v.style.display = e ? 'none' : 'block');
            c.querySelectorAll('.edit-mode').forEach(v => v.style.display = e ? 'block' : 'none');
            c.querySelector('.btn-edit').style.display = e ? 'none' : 'block';
            c.querySelector('.btn-save').style.display = e ? 'block' : 'none';
        };

        window.saveEntry = async (t, i) => {
            if(t==='inventory') {
                localDB[t][i].v1 = document.getElementById(`in-inventory-${i}-v1`).value;
                localDB[t][i].v2 = document.getElementById(`in-inventory-${i}-v2`).value;
                localDB[t][i].v3 = document.getElementById(`in-inventory-${i}-v3`).value;
            } else if(['archive', 'characters', 'mystery', 'fantasy'].includes(t)) {
                localDB[t][i].v1 = document.getElementById(`in-${t}-${i}-v1`).value;
                localDB[t][i].v2 = document.getElementById(`in-${t}-${i}-v2`).value;
            } else {
                localDB[t][i].v1 = document.getElementById(`in-${t}-${i}-v1`).value;
            }
            await save();
        };

        window.addNew = async (t) => {
            localDB[t].unshift({v1:'', v2:'', v3:''});
            await save();
        };

        window.delEntry = async (t, i) => {
            if(confirm('영구 삭제하시겠습니까?')) {
                localDB[t].splice(i,1);
                await save();
            }
        };

        window.addTodo = async (e) => {
            if(e.key==='Enter' && e.target.value!=='') {
                localDB.todos.push({t:e.target.value, d:false});
                e.target.value='';
                await save();
            }
        };

        window.updateGoal = async () => {
            localDB.goal.cur = document.getElementById('cur').value;
            localDB.goal.tar = document.getElementById('tar').value;
            await save();
        };

        window.searchContent = () => {
            renderContent(currentView, document.getElementById('globalSearch').value);
        };

        window.updateUI = () => {
            const list = document.getElementById('todo-list'); list.innerHTML = '';
            localDB.todos.forEach((t, i) => {
                list.insertAdjacentHTML('beforeend', `<div style="display:flex; align-items:center; margin-bottom:10px;">
                    <input type="checkbox" ${t.d?'checked':''} onchange="toggleTodo(${i})">
                    <span style="margin-left:10px;${t.d?'text-decoration:line-through;opacity:0.4':''}; flex:1; font-size:0.85rem;">${t.t}</span>
                    <button onclick="delTodo(${i})" style="border:none;background:none;color:#ff4d4d;cursor:pointer;">✕</button>
                </div>`);
            });
            const p = Math.min(Math.round((localDB.goal.cur / localDB.goal.tar) * 100), 100) || 0;
            document.getElementById('fill').style.width = p + '%';
            document.getElementById('perc').innerText = p + '%';
            document.getElementById('cur').value = localDB.goal.cur;
            document.getElementById('tar').value = localDB.goal.tar;
        };

        window.toggleTodo = async (i) => {
            localDB.todos[i].d = !localDB.todos[i].d;
            await save();
        };

        window.delTodo = async (i) => {
            localDB.todos.splice(i, 1);
            await save();
        };
    </script>
</body>
</html>